
----- Mar 4, 2024 at 12:41:48 ----- â†’ ----- Mar 13, 2024 at 23:19:24 -----
## â€œMoving Picturesâ€ tutorial

        # mkdir emp-single-end-sequences
        conda activate qiime2-amplicon-2023.9 \
        cd qiimeenv             

        # SampleMetaData
        wget \
        -O "sample-metadata.tsv" \
        "https://data.qiime2.org/2024.2/tutorials/moving-pictures/sample_metadata.tsv"

        ----- Mar 7, 2024 at 15:02:59 -----

    # Obtaining and importing data
        wget \
        -O "emp-single-end-sequences/barcodes.fastq.gz" \
        "https://data.qiime2.org/2024.2/tutorials/moving-pictures/emp-single-end-sequences/barcodes.fastq.gz"

        wget \
        -O "emp-single-end-sequences/sequences.fastq.gz" \
        "https://data.qiime2.org/2024.2/tutorials/moving-pictures/emp-single-end-sequences/sequences.fastq.gz"

    # Import sequence data files into a QIIME 2 artifact.
        qiime tools import \
        --type EMPSingleEndSequences \
        --input-path emp-single-end-sequences \
        --output-path emp-single-end-sequences.qza

    # check the UUID, type, and format , confirming that your import worked as expected
        qiime tools peek emp-single-end-sequences.qza

    # Demultiplexing sequences
        qiime demux emp-single \
        --i-seqs emp-single-end-sequences.qza \
        --m-barcodes-file sample-metadata.tsv \
        --m-barcodes-column barcode-sequence \
        --o-per-sample-sequences demux.qza \
        --o-error-correction-details demux-details.qza

    qiime demux summarize \
    --i-data demux.qza \
    --o-visualization demux.qzv
    
    qiime tools view demux.qzv

    # Sequence quality control and feature table construction
        ğŸŒ• This allows the user to remove low quality regions of the sequences. To determine what values to pass for these two parameters,
        you should review the Interactive Quality Plot tab in the demux.qzv file that was generated by qiime demux summarize above
        In the demux.qzv quality plots, we see that the quality of the initial bases seems to be high, 
            so we wonâ€™t trim any bases from the beginning of the sequences. The quality seems to drop off around position 120, so weâ€™ll truncate our sequences at 120 bases

        ğŸŒ• This next command may take up to 10 minutes to run, and is the slowest step in this tutorial
        â­ï¸ The DADA2 algorithm is both more sensitive and more specific than commonly used OTU methods, 
        and resolves amplicon sequence variants (ASVs) that differ by as little as one nucleotide.

        qiime dada2 denoise-single \
        --i-demultiplexed-seqs demux.qza \
        --p-trim-left 0 \
        --p-trunc-len 120 \
        --o-representative-sequences rep-seqs-dada2.qza \
        --o-table table-dada2.qza \
        --o-denoising-stats stats-dada2.qza

        qiime metadata tabulate \
        --m-input-file stats-dada2.qza \
        --o-visualization stats-dada2.qzv

        # ä¸‹æµã®Analysisã®ãŸã‚åå‰ã®å¤‰æ›´
        mv rep-seqs-dada2.qza rep-seqs.qza
        mv table-dada2.qza table.qza

    # FeatureTable and FeatureData summaries
        qiime feature-table summarize \
        --i-table table.qza \
        --o-visualization table.qzv \
        --m-sample-metadata-file sample-metadata.tsv
        qiime feature-table tabulate-seqs \
        --i-data rep-seqs.qza \
        --o-visualization rep-seqs.qzv

    # Generate a tree for phylogenetic diversity analyses
        qiime phylogeny align-to-tree-mafft-fasttree \
        --i-sequences rep-seqs.qza \
        --o-alignment aligned-rep-seqs.qza \
        --o-masked-alignment masked-aligned-rep-seqs.qza \
        --o-tree unrooted-tree.qza \
        --o-rooted-tree rooted-tree.qza

    # Alpha and beta diversity analysis <â­ï¸ sampling-depthã¯è¦å­¦ç¿’> <â­ï¸ å„çµ±è¨ˆé‡ã¯è¦å­¦ç¿’>
        â­ï¸ An important parameter that needs to be provided to this script is --p-sampling-depth
            this script will randomly subsample the counts from each sample to the value provided for this parameter
            Choosing this value is tricky. We recommend making your choice by reviewing the information presented in the table.qzv file that was created above.
            Choose a value that is as high as possible (so you retain more sequences per sample) while excluding as few samples as possible.
        ğŸŒ• View the table.qzv QIIME 2 artifact, and in particular the Interactive Sample Detail tab in that visualization
            What value would you choose to pass for --p-sampling-depth? How many samples will be excluded from your analysis based on this choice?
            How many total sequences will you be analyzing in the core-metrics-phylogenetic command?
        ğŸŒ• Note
            In many Illumina runs youâ€™ll observe a few samples that have very low sequence counts. You will typically want to exclude those from the analysis by choosing a larger value for the sampling depth at this stage.

        qiime diversity core-metrics-phylogenetic \
        --i-phylogeny rooted-tree.qza \
        --i-table table.qza \
        --p-sampling-depth 1103 \
        --m-metadata-file sample-metadata.tsv \
        --output-dir core-metrics-results

        qiime diversity alpha-group-significance \
        --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
        --m-metadata-file sample-metadata.tsv \
        --o-visualization core-metrics-results/faith-pd-group-significance.qzv

        qiime diversity alpha-group-significance \
        --i-alpha-diversity core-metrics-results/evenness_vector.qza \
        --m-metadata-file sample-metadata.tsv \
        --o-visualization core-metrics-results/evenness-group-significance.qzv

        qiime diversity beta-group-significance \
        --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
        --m-metadata-file sample-metadata.tsv \
        --m-metadata-column body-site \
        --o-visualization core-metrics-results/unweighted-unifrac-body-site-significance.qzv \
        --p-pairwise

        qiime diversity beta-group-significance \
        --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
        --m-metadata-file sample-metadata.tsv \
        --m-metadata-column subject \
        --o-visualization core-metrics-results/unweighted-unifrac-subject-group-significance.qzv \
        --p-pairwise

        qiime emperor plot \
        --i-pcoa core-metrics-results/unweighted_unifrac_pcoa_results.qza \
        --m-metadata-file sample-metadata.tsv \
        --p-custom-axes days-since-experiment-start \
        --o-visualization core-metrics-results/unweighted-unifrac-emperor-days-since-experiment-start.qzv

        qiime emperor plot \
        --i-pcoa core-metrics-results/bray_curtis_pcoa_results.qza \
        --m-metadata-file sample-metadata.tsv \
        --p-custom-axes days-since-experiment-start \
        --o-visualization core-metrics-results/bray-curtis-emperor-days-since-experiment-start.qzv

    # Alpha rarefaction plotting
        ğŸŒ• The visualization will have two plots
        alpha rarefaction plot: the richness of the samples has been fully observed or sequenced
                                If the lines in the plot appear to â€œlevel outâ€ (i.e., approach a slope of zero) at some sampling depth along the x-axis, 
                                that suggests that collecting additional sequences beyond that sampling depth would not be likely to result in the observation of additional features
                                If the lines in a plot donâ€™t level out, this may be because the richness of the samples hasnâ€™t been fully observed yet (because too few sequences were collected), 
                                or it could be an indicator that a lot of sequencing error remains in the data (which is being mistaken for novel diversity).                            
        important when grouping samples by metadata:  When grouping samples by metadata, it is therefore essential to look at the bottom plot to ensure that the data presented in the top plot is reliable.

        qiime diversity alpha-rarefaction \
    --i-table table.qza \
    --i-phylogeny rooted-tree.qza \
    --p-max-depth 4000 \
    --m-metadata-file sample-metadata.tsv \
    --o-visualization alpha-rarefaction.qzv

    qiime tools view alpha-rarefaction.qzv
        
    # Taxonomic analysis
        assign taxonomy to the sequences in our FeatureData[Sequence] QIIME 2 artifact
        using a pre-trained Naive Bayes classifier and the q2-feature-classifier plugin
        Greengenes 13_8 99% OTUs, where the sequences have been trimmed to only include 250 bases 
        from the region of the 16S that was sequenced in this analysis (the V4 region, bound by the 515F/806R primer pair)

        â­ï¸ è‡ªèº«ã®NGSData [å¢—å¹…ã«ä½¿ç”¨ã—ãŸPrimer,SequenceReadLength,SamplePrepareMethods,SequenceParameters] ã«å¿œã˜, å‚ç…§Classifierã‚’Trainingã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        Training feature classifiers with q2-feature-classifier
        https://docs.qiime2.org/2024.2/tutorials/feature-classifier/

        wget \
        -O "gg-13-8-99-515-806-nb-classifier.qza" \
        "https://data.qiime2.org/2024.2/common/gg-13-8-99-515-806-nb-classifier.qza"

        [Pythonã«ã¦å‡¦ç†ã•ã‚Œã‚‹]
        qiime feature-classifier classify-sklearn \
        --i-classifier gg-13-8-99-515-806-nb-classifier.qza \
        --i-reads rep-seqs.qza \
        --o-classification taxonomy.qza

        qiime metadata tabulate \
        --m-input-file taxonomy.qza \
        --o-visualization taxonomy.qzv

        â­ï¸ æ£’ã‚°ãƒ©ãƒ•ã§åˆ†é¡ã‚’è¡¨ç¤º
        qiime taxa barplot \
        --i-table table.qza \
        --i-taxonomy taxonomy.qza \
        --m-metadata-file sample-metadata.tsv \
        --o-visualization taxa-bar-plots.qzv

    # Differential abundance testing with ANCOM-BC [â­ï¸ è¦å­¦ç¿’ â†’ çµæœã®è§£é‡ˆãŒé›£ã—ã„(240313) â†’ Pluginã«ã¤ã„ã¦è©³ã—ãå­¦ç¿’]
        ANCOM-BC is a compositionally-aware linear regression model that allows for testing differentially abundant features across groups 
            while also implementing bias correction, and is currently implemented in the q2-composition plugin
        ANCOM-BC operates on a FeatureTable[Frequency] QIIME 2 artifact

        ğŸ’« Differential abundance testing with ANCOM-BC
        ğŸŒ• Accurately identifying features that are differentially abundant across sample types in microbiome data is 
            a challenging problem and an open area of research
        â­ï¸ new approaches for differential abundance testing are regularly introduced, 
            and itâ€™s worth assessing the current state of the field when performing differential abundance testing to see 
            if there are new methods that might be useful for your data
        
        # å¤‰æ•°ã‚’æ¸›ã‚‰ã™(Sampleé–“ã®OTUså­˜åœ¨é‡å·®ç•°ã®å‰ã«æ˜ã‚‰ã‹ã«å­˜åœ¨ç¨®ãŒç•°ãªã‚‹ã‚ˆã†ãªå‡¦ç†åŒºåŒå£«ã‚’é¿ã‘ã‚‹ãŸã‚ã«, Filtering)
        qiime feature-table filter-samples \
        --i-table table.qza \
        --m-metadata-file sample-metadata.tsv \
        --p-where "[body-site]='gut'" \
        --o-filtered-table gut-table.qza

        qiime composition ancombc \
        --i-table gut-table.qza \
        --m-metadata-file sample-metadata.tsv \
        --p-formula 'subject' \
        --o-differentials ancombc-subject.qza

        qiime composition da-barplot \
        --i-data ancombc-subject.qza \
        --p-significance-threshold 0.001 \
        --o-visualization da-barplot-subject.qzv


        qiime taxa collapse \
        --i-table gut-table.qza \
        --i-taxonomy taxonomy.qza \
        --p-level 6 \
        --o-collapsed-table gut-table-l6.qza

        qiime composition ancombc \
        --i-table gut-table-l6.qza \
        --m-metadata-file sample-metadata.tsv \
        --p-formula 'subject' \
        --o-differentials l6-ancombc-subject.qza

        qiime composition da-barplot \
        --i-data l6-ancombc-subject.qza \
        --p-significance-threshold 0.001 \
        --p-level-delimiter ';' \
        --o-visualization l6-da-barplot-subject.qzv



--------------------------------------------------

## tutorial     [SRA_Dataã®Download [æ¬¡ä¸–ä»£ã‚·ãƒ¼ã‚±ãƒ³ã‚µ DRY è§£ææ•™æœ¬ã‚ˆã‚Š]]
   1. ImportData 
   # SRR_Acc_List.txt ãŒå­˜åœ¨ã™ã‚‹directory ã« cd
   prefetch --option-file SRR_Acc_List.txt [accession_num_list]                cdã«å„accession_num.fileãŒä½œæˆã•ã‚Œã‚‹

   # |ã¯ãƒ‘ã‚¤ãƒ—ã§ã‚ã‚Š, xargs -n1(ä¸€ã¤ãšã¤)ã«ã¦fastq-dump cmdã«å¼•æ•°ã‚’æ¸¡ã™  
   # å„SRA.fileã‚’fastq.fileã¸fastq-dump cmdã«ã¦å¤‰æ›, xargsã¯è¦å­¦ç¿’
   at ../SRR_Acc_List.txt | xargs -n1 fastq-dump --gzip --split-files
   xargs -n1 fastq-dump --gzip --split-files < SRR_Acc_List.txt 
   ls * 
   ls * | wc -l

   # fastq.file â†’ SampleName_S1_L001.tastq.gzã®ã‚ˆã†ã«rename
   # (Perl) rename cmdã‚’ä½¿ç”¨,cdå†….fastq.gzã«å¯¾ã—,_1 â†’ _S1_L001_R1_001ã«ç½®æ›, æ­£è¦è¡¨ç¾ã‚’ä½¿ç”¨å¯èƒ½
   rename 's/_1/_S1_L001_R1_001/' *.fastq.gz
   rename 's/_2/_S1_L001_R2_001/' *.fastq.gz

   2. Analysis
   conda activate qiime2-amplicon-2023.9
   cd /Users/saitoikuto/miniforge3/envs/qiime2-amplicon-2023.9/QIIME_practice

   # .fastq import 
   qiime tools import \
   --type 'SampleData[PairedEndSequencesWithQuality]' \
   --input-path fastq \
   --input-format CasavaOneEightSingleLanePerSampleDirFmt \
   --output-path demux.qza

   # summary.file
   qiime demux summarize \
   --i-data demux.qza \
   --o-visualization demux.qzv

   # graphic(visualization)            https://view.qiime2.org/
   # interactive quality plot tab â†’ read_long_density æ‹¡å¤§ã—ãŸã„é ˜åŸŸã‚’é¸æŠã§zoom, ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§è§£é™¤
   â­ï¸ qiime tools view                 file.qzv(.qzvãŒå­˜åœ¨ã™ã‚‹directoryã«ç§»å‹•ã™ã‚‹å¿…è¦)

   # DADA2[trimming,merge,clustering,OTUs,chimera] (240211,20mç¨‹åº¦å¿…è¦)
   qiime dada2 denoise-paired \                    denoiseã™ã‚‹æ–¹æ³•ã‚’é¸æŠ
   --verbose \
   --p-n-threads 0 \                               ä½¿ç”¨å¯èƒ½ãªå…¨CPUã‚³ã‚¢ã‚’ä½¿ç”¨
   --p-trim-left-f 17 \                            ForwardPrimer_5'ã‹ã‚‰Trimmingã™ã‚‹æ•°=PrimerLength
   --p-trim-left-r 21 \                            ReversePrimer_5'ã‹ã‚‰Trimmingã™ã‚‹æ•°=PrimerLength
   --p-trunc-len-f 290 \                           ForwardPrimer_5'ã‹ã‚‰ä½¿ç”¨ã™ã‚‹å¡©åŸºæ•°(ä»¥é™ãŒtrimming)
   --p-trunc-len-r 250 \                           ReversePrimer_5'ã‹ã‚‰ä½¿ç”¨ã™ã‚‹å¡©åŸºæ•°(ä»¥é™ãŒtrimming)
   --i-demultiplexed-seqs demux.qza \
   --o-table table.qza \
   --o-representative-sequences rep-seqs.qza \
   --o-denoising-stats stats-dada2.qza

   2) Filtering .......................
   3) Learning Error Rates
   284179896 total bases in 1040952 reads from 15 samples will be used for learning the error rates.
   238378008 total bases in 1040952 reads from 15 samples will be used for learning the error rates.
   3) Denoise samples .......................
   .......................
   5) Remove chimeras (method = consensus)
   6) Report read numbers through the pipeline
   7) Write output
   # .qzaãŒ3ã¤artifactã¨ã—ã¦ä½œæˆã•ã‚Œã‚‹
   Saved FeatureTable[Frequency] to: table.qza     
   Saved FeatureData[Sequence] to: rep-seqs.qza
   Saved SampleData[DADA2Stats] to: stats-dada2.qza

   # DADA2[summary.file]
   qiime metadata tabulate \
   --m-input-file stats-dada2.qza \
   --o-visualization stats-dada2.qzv

   qiime feature-table summarize \             Number of features=OTUs
   --i-table table.qza \
   --o-visualization table.qzv \
   --m-sample-metadata-file metadata.txt       äºˆã‚[ID,treatment,sample]ç­‰ã®æƒ…å ±ã‚’è¨˜è¼‰ã—ãŸ.txtã«tableã‚’è¿½åŠ ã™ã‚‹

   qiime feature-table tabulate-seqs \         Featureã®ä»£è¡¨é…åˆ—ã‚’ç®—å‡º
   --i-data rep-seqs.qza \
   --o-visualization rep-seqs.qzv

   # åˆ†å­ç³»çµ±æ¨¹[è¦å­¦ç¿’-240211]
   qiime phylogeny align-to-tree-mafft-fasttree \
   --i-sequences rep-seqs.qza \
   --o-alignment aligned-rep-seqs.qza \
   --o-masked-alignment masked-aligned-rep-seqs.qza \
   --o-tree unrooted-tree.qza \
   --o-rooted-tree rooted-tree.qza

   # Î±/Î²å¤šæ§˜æ€§
   qiime diversity core-metrics-phylogenetic \
   --i-phylogeny rooted-tree.qza \
   --i-table table.qza \
   --p-sampling-depth 43256 \
   --m-metadata-file metadata.txt \
   --output-dir core-metrics-results

   qiime diversity alpha-group-significance \
   --i-alpha-diversity core-metrics-results/observed_features_vector.qza \
   --m-metadata-file metadata.txt \
   --o-visualization core-metrics-results/observed_otus-group-significance.qzv

   qiime diversity alpha-group-significance \
   --i-alpha-diversity core-metrics-results/shannon_vector.qza \
   --m-metadata-file metadata.txt \
   --o-visualization core-metrics-results/shannon-group-significance.qzv

   qiime diversity alpha-group-significance \
      --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
      --m-metadata-file metadata.txt \
      --o-visualization core-metrics-results/faith-pd-group-significance.qzv

   qiime diversity beta-group-significance \
   --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
   --m-metadata-file metadata.txt \
   --m-metadata-column group \                      metadata.txtã®groupColumnã§ç¾¤åˆ†ã‘ã•ã‚Œã‚‹
   --o-visualization core-metrics-results/unweighted-unifrac-group-significance.qzv \
   --p-pairwise

   qiime diversity beta-group-significance \
   --i-distance-matrix core-metrics-results/weighted_unifrac_distance_matrix.qza \
   --m-metadata-file metadata.txt \
   --m-metadata-column group \
   --o-visualization core-metrics-results/weighted-unifrac-group-significance.qzv \
   --p-pairwise

   # ç³»çµ±è§£æ
   qiime feature-classifier classify-sklearn \
   --p-n-jobs -1 \
   --i-classifier gg-13-8-99-nb-classifier.qza \
   --i-reads rep-seqs.qza \
   --o-classification taxonomy.qza

   qiime metadata tabulate \
   --m-input-file taxonomy.qza \
   --o-visualization taxonomy.qzv
   # åˆ†é¡åˆ¥ã®histgramãŒä½œæˆã•ã‚Œã‚‹
   qiime taxa barplot \
   --i-table table.qza \
   --i-taxonomy taxonomy.qza \
   --m-metadata-file metadata.txt \
   --o-visualization taxa-bar-plots.qzv

   # heatmap
   qiime taxa collapse \
   --i-table table.qza \
   --i-taxonomy taxonomy.qza \
   --p-level 5 \
   --o-collapsed-table table-l5.qza

   qiime feature-table heatmap \
   --i-table table-l5.qza \
   --m-sample-metadata-file metadata.txt \
   --m-sample-metadata-column group \
   --o-visualization heatmap_l5_group.qzv

   # å¤‰å‹•èŒç¨®ã®æ¨å®š [è¦å­¦ç¿’-240212]
   qiime feature-table filter-samples \
   --i-table table.qza \
   --m-metadata-file metadata.txt \
   --p-where "host_genotype='ob'" \            obã®ã¿ã‚’æŠ½å‡º
   --o-filtered-table table_ob.qza

   qiime taxa collapse \
   --i-table table_ob.qza \
   --i-taxonomy taxonomy.qza \
   --p-level 5 \
   --o-collapsed-table table_ob_l5.qza

   qiime composition add-pseudocount \
   --i-table table_ob_l5.qza \
   --o-composition-table comp_table_ob_l5.qza

   qiime composition ancom \
   --i-table comp_table_ob_l5.qza \
   --m-metadata-file metadata.txt \
   --m-metadata-column host_diet \
   --o-visualization ancom_table_ob_l5_diet.qzv


--------------------------------------------------